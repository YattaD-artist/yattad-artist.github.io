<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Truyện Tranh</title>

    <!-- Google Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Amatic+SC:wght@400;700&family=Noto+Sans+JP&family=Patrick+Hand&family=Road+Rage&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Preload Hình ảnh & Âm thanh -->
    <link rel="preload" as="image" href="comics/PunkgaMerch/00.webp" fetchpriority="high" />
    <link rel="preload" as="image" href="comics/PunkgaMerch/01.webp" fetchpriority="high" />
    <link rel="preload" as="image" href="comics/PunkgaMerch/02.webp" />
    <link rel="preload" as="audio" href="assets/sfx/Pictures/Paper1.mp3" />
    <link rel="preload" as="audio" href="assets/sfx/Pictures/Paper2.mp3" />
    <link rel="preload" as="audio" href="assets/sfx/Pictures/Paper3.mp3" />
    <link rel="preload" as="audio" href="assets/sfx/Pictures/Paper4.mp3" />

    <style>
      /* =============== Chế độ Dark Mode =============== */
      html {
        margin: 0;
        background-color: #1f1a17;
        overflow: hidden;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      body {
        margin: 0;
        padding: 2rem;
        font-family: 'Noto Sans JP', sans-serif;
        background-color: #1f1a17;
        color: #f5efe6;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        box-sizing: border-box;
      }
      h1 {
        font-family: 'Road Rage', cursive;
        font-size: clamp(4rem, 9vw, 5.5rem);
        color: #1cd49d;
        text-align: center;
        margin: 0.5rem 0 1.5rem;
        padding-bottom: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.35px;
      }

      /* =============== Hiệu ứng hình vuông trôi =============== */
      .floating-pattern {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        overflow: hidden;
      }
      .square {
        position: absolute;
        background-color: rgba(255, 255, 255, 0.04);
        transform: rotate(45deg);
        animation: floatSquare linear infinite;
      }
      @keyframes floatSquare {
        0% {
          transform: translateY(0) translateX(0) rotate(45deg);
          opacity: 0.6;
        }
        50% {
          transform: translateY(-50vh) translateX(10px) rotate(45deg);
        }
        100% {
          transform: translateY(-100vh) translateX(-10px) rotate(45deg);
          opacity: 0;
        }
      }
      @keyframes floatY {
        0%, 100% {
          transform: rotate(45deg) translateY(0);
        }
        50% {
          transform: rotate(45deg) translateY(-10px);
        }
      }

      /* =============== Menu chính =============== */
      .menu {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-evenly;
        row-gap: 4rem;
        column-gap: 4rem;
        margin-top: 4rem;
        padding: 0 5vw;
        position: relative;
        max-width: 100%;
        box-sizing: border-box;
      }
      .menu a {
        --rotate: rotate(45deg);
        width: 120px;
        height: 120px;
        background-color: rgba(255, 255, 255, 0.05);
        transform: var(--rotate);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.15);
        transition: all 0.3s ease;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: floatY 4s ease-in-out infinite;
        animation-delay: calc(var(--i) * 0.3s);
        z-index: 1;
      }
      .menu a span {
        transform: rotate(-45deg);
        font-family: 'Amatic SC', cursive;
        font-size: 1.4rem;
        text-align: center;
        padding: 0 0.5rem;
        color: #f5efe6;
      }
      .menu a:hover {
        background-color: #e9282c;
        box-shadow: 0 0 15px #e9282c;
      }
      @media (max-width: 600px) {
        .menu {
          column-gap: 1rem;
          padding: 0 0.5rem;
        }
        .menu a {
          width: 90px;
          height: 90px;
          font-size: 1.2rem;
        }
      }

      /* =============== Layout chung & Components =============== */
      .panel {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        width: 100%;
        padding-top: clamp(8vh, 12vh, 16vh);
        box-sizing: border-box;
      }
      .panel-inner {
        width: 100vw;
        max-width: 100vw;
        padding: 0 1rem;
        background: transparent;
      }
      .back-link {
        display: block;
        text-align: center;
        font-size: 1rem;
        margin-top: 3rem;
        padding-top: 1rem;
        color: #a19386;
        font-family: 'Patrick Hand', cursive;
        text-decoration: none;
        transition: color 0.2s;
      }
      .back-link:hover {
        color: #e9282c;
      }

      /* =============== Nút chuyển đổi chủ đề =============== */
      .theme-toggle {
        position: fixed;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 1.8rem;
        cursor: pointer;
        z-index: 1000;
        color: #f5efe6;
        transition: color 0.3s;
      }

      /* =============== Overlay & Trình chiếu =============== */
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(4px);
        z-index: 100;
        display: none;
        justify-content: center;
        align-items: center;
      }
      .deck img {
        position: absolute;
        top: 50%;
        left: 50%;
        max-height: 85vh;
        max-width: 85vw;
        transform: translate(-50%, -50%) scale(0.6);
        transition: transform 0.5s ease, z-index 0.3s ease;
        border-radius: 6px;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.5);
        filter: contrast(0.8) brightness(0.8);
        pointer-events: none;
      }
      .deck img.active {
        transform: translate(-50%, -50%) scale(1);
        z-index: 30;
        filter: none;
        pointer-events: auto;
      }
      .deck img.left {
        transform: translate(calc(-150% + 30px), -50%) scale(0.6) rotate(-5deg);
      }
      .deck img.right {
        transform: translate(calc(50% + 30px), -50%) scale(0.6) rotate(5deg);
      }
      .caption,
      .close-btn,
      .restart-btn {
        font-family: 'Patrick Hand', cursive;
        z-index: 20;
      }
      .caption {
        position: absolute;
        bottom: 32px;
        width: 100%;
        text-align: center;
        font-size: clamp(1.1rem, 2.5vw, 1.8rem);
        letter-spacing: 1px;
        color: #f5efe6;
      }
      .close-btn {
        position: absolute;
        top: 20px;
        right: 28px;
        font-size: 2em;
        cursor: pointer;
        transition: color 0.2s;
        color: #f5efe6;
      }
      .close-btn:hover {
        color: #e9282c;
      }
      .restart-btn {
        position: absolute;
        right: 30px;
        bottom: 90px;
        font-size: clamp(1rem, 2vw, 1.6rem);
        background: rgba(255, 255, 255, 0.1);
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        display: none;
        transition: background 0.2s;
        color: #f5efe6;
      }
      .restart-btn:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      /* =============== Light Mode Overrides =============== */
      body.light-mode {
        background-color: #f5f2ee;
        color: #2c2622;
      }
      body.light-mode h1 {
        color: #e32b62;
      }
      body.light-mode .menu a span {
        color: #2c2622;
      }
      body.light-mode .menu a {
        background-color: rgba(44, 38, 34, 0.05);
        box-shadow: 0 0 10px rgba(44, 38, 34, 0.15);
      }
      body.light-mode .menu a:hover {
        background-color: #32d7d3;
        box-shadow: 0 0 15px #32d7d3;
      }
      body.light-mode .square {
        background-color: rgba(44, 38, 34, 0.04);
      }
      body.light-mode .back-link {
        color: #766b60;
      }
      body.light-mode .back-link:hover {
        color: #32d7d3;
      }
      body.light-mode .caption {
        color: #2c2622;
      }
      body.light-mode .close-btn {
        color: #2c2622;
      }
      body.light-mode .close-btn:hover {
        color: #32d7d3;
      }
      body.light-mode .restart-btn {
        color: #2c2622;
        background: rgba(0, 0, 0, 0.05);
      }
      body.light-mode .restart-btn:hover {
        background: rgba(0, 0, 0, 0.1);
      }
      .light-mode .theme-toggle {
        color: #2c2622;
      }
    </style>
  </head>

  <body>
    <!-- Container cho hiệu ứng nền hình vuông -->
    <div class="floating-pattern" id="floating-pattern"></div>

    <!-- Nút chuyển đổi chế độ sáng/tối -->
    <button class="theme-toggle" id="themeToggle" title="Đổi chế độ sáng / tối">
      <i class="fa-solid fa-eye"></i>
    </button>

    <!-- Nội dung chính: tiêu đề và menu truyện -->
    <div class="panel">
      <div class="panel-inner">
        <h1>TRUYỆN TRANH</h1>
        <nav class="menu">
          <a id="punkga-link" style="--i: 0"><span>PunkgaMerch</span></a>
          <a data-story="RedRuby" class="story-link unavailable" style="--i: 1"><span>Red & Ruby</span></a>
          <a data-story="StillTrue" class="story-link unavailable" style="--i: 2"><span>Still become true</span></a>
          <a data-story="LeThan" class="story-link unavailable" style="--i: 3"><span>Lê Thận</span></a>
          <a data-story="Raku" class="story-link unavailable" style="--i: 4"><span>Raku</span></a>
          <a data-story="Breakthrough" class="story-link unavailable" style="--i: 5"><span>Breakthrough</span></a>
        </nav>
        <a href="index.html" class="back-link">← Quay lại trang chủ</a>
      </div>
    </div>

    <!-- Overlay cho slideshow truyện PunkgaMerch -->
    <div class="overlay" id="overlay">
      <div class="close-btn" id="closeBtn">✕</div>
      <div class="deck" id="deck"></div>
      <div class="caption" id="caption"></div>
      <div class="restart-btn" id="restartBtn">← Quay lại trang đầu</div>
    </div>

    <script>
      /**
       * 1. Tạo hiệu ứng nền các hình vuông trôi ngẫu nhiên
       */
      (function createFloatingSquares() {
        const container = document.getElementById('floating-pattern');
        const count = 60;
        const used = new Set();

        for (let i = 0; i < count; i++) {
          const sq = document.createElement('div');
          sq.classList.add('square');

          let left, bottom, key;
          do {
            left = Math.floor(Math.random() * 95);
            bottom = Math.floor(Math.random() * 60);
            key = `${left}-${bottom}`;
          } while (used.has(key));

          used.add(key);
          const size = 20 + Math.random() * 20;
          sq.style.left = `${left}vw`;
          sq.style.bottom = `${bottom}vh`;
          sq.style.width = `${size}px`;
          sq.style.height = `${size}px`;
          sq.style.animationDuration = `${12 + Math.random() * 10}s`;
          container.appendChild(sq);
        }
      })();

      /**
       * 2. Bố trí menu với offset ngẫu nhiên và tạm dừng hiệu ứng khi hover
       */
      (function setupMenuInteraction() {
        const items = Array.from(document.querySelectorAll('.menu a'));
        const menu = document.querySelector('.menu');
        const threshold = 60;

        // Offset ngẫu nhiên
        items.forEach((el) => {
          el.style.marginLeft = `${Math.random() * 40 - 20}px`;
          el.style.marginTop = `${Math.random() * 30 - 15}px`;
        });

        // Pause khi hover gần phần tử
        menu.addEventListener('mousemove', (e) => {
          items.forEach((el) => {
            const r = el.getBoundingClientRect();
            const d = Math.hypot(
              e.clientX - (r.left + r.width / 2),
              e.clientY - (r.top + r.height / 2)
            );
            el.style.animationPlayState = d < threshold ? 'paused' : 'running';
          });
        });
        menu.addEventListener('mouseleave', () => {
          items.forEach((el) => {
            el.style.animationPlayState = 'running';
          });
        });
      })();

      /**
       * 3. Chuyển đổi chế độ sáng / tối
       */
      const themeToggle = document.getElementById('themeToggle');
      themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('light-mode');
      });

      /**
       * 4. Cài đặt slideshow cho PunkgaMerch
       */
      (function setupGallery() {
        const link = document.getElementById('punkga-link');
        const overlay = document.getElementById('overlay');
        const deck = document.getElementById('deck');
        const caption = document.getElementById('caption');
        const closeBtn = document.getElementById('closeBtn');
        const restartBtn = document.getElementById('restartBtn');

        const total = 15;
        const images = [];
        let index = 0;
        let transitioning = false;

        // Tạo danh sách chú thích và âm thanh
        const caps = Array.from({ length: total }, (_, i) =>
          i === 0 ? 'Trang Bìa' : `Trang ${i}`
        );
        const sounds = Array.from({ length: 4 }, (_, i) =>
          `assets/sfx/Pictures/Paper${i + 1}.mp3`
        );

        // Load hình ảnh vào DOM
        for (let i = 0; i < total; i++) {
          const img = document.createElement('img');
          img.src = `comics/PunkgaMerch/${String(i).padStart(2, '0')}.webp`;
          if (i > 2) img.loading = 'lazy';
          deck.appendChild(img);
          images.push(img);
          img.addEventListener('transitionend', () => {
            if (img.classList.contains('active')) transitioning = false;
          });
        }

        // Cập nhật trạng thái slideshow
        function update() {
          images.forEach((img, i) => {
            img.className = '';
            img.style.zIndex = '';
            if (i === index) {
              img.classList.add('active');
              img.style.zIndex = '30';
            } else if (i < index) {
              img.classList.add('left');
              img.style.zIndex = String(5 + i);
            } else {
              img.classList.add('right');
              img.style.zIndex = String(5 - (i - index));
            }
          });
          caption.textContent = caps[index];
          restartBtn.style.display = index === total - 1 ? 'block' : 'none';
        }

        // Phát âm thanh chuyển trang
        function playSound() {
          const audio = new Audio(
            sounds[Math.floor(Math.random() * sounds.length)]
          );
          audio.playbackRate = 1.5;
          audio.play().catch(() => {});
        }

        // Các hàm điều khiển slideshow
        function show() {
          index = 0;
          transitioning = false;
          overlay.style.display = 'flex';
          update();
        }
        function hide() {
          overlay.style.display = 'none';
          transitioning = false;
        }
        function next() {
          if (!transitioning && index < total - 1) {
            playSound();
            transitioning = true;
            index++;
            update();
          }
        }
        function prev() {
          if (!transitioning && index > 0) {
            playSound();
            transitioning = true;
            index--;
            update();
          }
        }
        function restart() {
          if (!transitioning) {
            index = 0;
            update();
          }
        }

        // Đăng ký sự kiện
        link.addEventListener('click', show);
        closeBtn.addEventListener('click', hide);
        restartBtn.addEventListener('click', restart);
        overlay.addEventListener('click', (e) => {
          const rect = overlay.getBoundingClientRect();
          if (e.clientX > rect.left + rect.width / 2 + 50) next();
          else if (e.clientX < rect.left + rect.width / 2 - 50) prev();
        });
        overlay.addEventListener('touchstart', (e) =>
          (touchStartX = e.touches[0].clientX)
        );
        overlay.addEventListener('touchend', (e) => {
          const diff = e.changedTouches[0].clientX - touchStartX;
          if (Math.abs(diff) > 50) (diff < 0 ? next() : prev());
        });
        window.addEventListener('keydown', (e) => {
          if (overlay.style.display === 'flex' && !transitioning) {
            if (e.key === 'ArrowRight') next();
            if (e.key === 'ArrowLeft') prev();
            if (e.key === 'Escape') hide();
          }
        });
      })();
    </script>
  </body>
</html>
