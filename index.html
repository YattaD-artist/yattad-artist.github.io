<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YattaD</title>
  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans&display=swap" rel="stylesheet" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Pixelify Sans', sans-serif;
      background-color: #f8f8ff;
      overflow: hidden;
    }

    .container {
      position: relative;
      z-index: 2;
      text-align: center;
      padding-top: 48px;
    }

    h1 {
      font-size: 2.5em;
      margin: 0.2em 0 0;
    }

    p {
      font-size: 1.2em;
      color: #444;
    }

    .menu {
      text-align: center;
      margin-top: 20px;
    }

    .menu a {
      display: inline-block;
      text-decoration: none;
      color: #334;
      font-size: 1.1em;
      margin: 0 12px;
      transition: transform 0.2s ease, color 0.2s ease;
    }

    .menu a:hover {
      transform: scale(1.2);
      color: #4e5ba6;
    }

    .background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-image: url('assets/Dat.png');
      background-size: 98px 98px;
      opacity: 0.3;
      z-index: 0;
    }

    #character {
      position: absolute;
      width: 48px;
      height: 48px;
      image-rendering: pixelated;
      z-index: 1;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="background"></div>

  <div class="container" id="text-container">
    <header>
      <h1>YattaD</h1>
      <p>Chào mừng đến với trang web cá nhân của YattaD</p>
    </header>

    <nav class="menu">
      <a href="about.html">Giới thiệu</a>
      <a href="illustrations.html">Minh Họa</a>
      <a href="concepts.html">Thiết kế</a>
      <a href="comics.html">Truyện Tranh</a>
    </nav>
  </div>

  <img id="character" src="assets/character/Idle/Idle00.png" alt="Vydra" />

<script>
const character = document.getElementById("character");
const textContainer = document.getElementById("text-container");

let posX = window.innerWidth / 2;
let posY = window.innerHeight / 2 + 100;
let frame = 0;
let state = "idle";
let direction = "";
let isMoving = false;
let isChoosingDirection = false;
let frameTimer;

const directions = ["", "U", "L", "R"];
const dirVectors = {
  "": [0, 1], // xuống
  "U": [0, -1],
  "L": [-1, 0],
  "R": [1, 0]
};

function updateSprite() {
  let folder = "Idle";
  if (state === "walk") folder = "Walk";
  else if (state === "run") folder = "Run";

  const suffix = direction !== "" ? direction : "";
  const maxFrame = (state === "run") ? 8 : 16;
  const frameStr = (frame % maxFrame).toString().padStart(2, "0");

  const fileName = direction === "" 
    ? `${folder}${frameStr}.png` 
    : `${folder}${suffix}${frameStr}.png`;

  character.src = `assets/character/${folder}/${fileName}`;
}

function startFrameLoop(speed) {
  if (frameTimer) clearInterval(frameTimer);
  frameTimer = setInterval(() => {
    frame++;
    updateSprite();
  }, speed);
}

function stopFrameLoop() {
  clearInterval(frameTimer);
}

function checkCollision(dx, dy) {
  const futureX = posX + dx;
  const futureY = posY + dy;
  const charRect = {
    left: futureX, top: futureY,
    right: futureX + 48, bottom: futureY + 48
  };
  const screen = {
    width: window.innerWidth,
    height: window.innerHeight
  };

  if (
    charRect.left < 0 || charRect.right > screen.width ||
    charRect.top < 0 || charRect.bottom > screen.height
  ) return true;

  const textRect = textContainer.getBoundingClientRect();
  const overlap = !(
    charRect.right < textRect.left ||
    charRect.left > textRect.right ||
    charRect.bottom < textRect.top ||
    charRect.top > textRect.bottom
  );

  return overlap;
}

function moveOneStep(type, callback) {
  const [vx, vy] = dirVectors[direction];
  const dx = vx * 48;
  const dy = vy * 48;
  const duration = 500;
  const steps = (type === "run") ? 8 : 16;
  const interval = duration / steps;
  let current = 0;

  startFrameLoop(interval);

  function step() {
    if (current >= steps) {
      stopFrameLoop();
      callback();
      return;
    }
    posX += dx / steps;
    posY += dy / steps;
    character.style.left = `${posX}px`;
    character.style.top = `${posY}px`;
    current++;
    setTimeout(step, interval);
  }

  step();
}

function chooseDirection() {
  isChoosingDirection = true;
  direction = directions[Math.floor(Math.random() * directions.length)];
  state = "idle";
  frame = 0;
  updateSprite();

  setTimeout(() => {
    isChoosingDirection = false;
    chooseAction();
  }, 300);
}

function chooseAction() {
  if (isMoving) return;
  const r = Math.random();
  const steps = 1 + Math.floor(Math.random() * 3);
  const moveType = (r < 0.5) ? "walk" : "run";
  startMove(moveType, steps);
}

function startMove(type, steps) {
  if (isMoving) return;
  isMoving = true;
  state = type;
  frame = 0;
  updateSprite();

  let count = 0;
  function next() {
    if (count >= steps) {
      isMoving = false;
      state = "idle";
      frame = 0;
      updateSprite();
      setTimeout(chooseDirection, 1000 + Math.random() * 1000);
      return;
    }

    const [vx, vy] = dirVectors[direction];
    const dx = vx * 48;
    const dy = vy * 48;

    if (checkCollision(dx, dy)) {
      isMoving = false;
      state = "idle";
      frame = 0;
      updateSprite();
      setTimeout(chooseDirection, 1000);
      return;
    }

    moveOneStep(type, () => {
      count++;
      next();
    });
  }

  next();
}

function idleLoop() {
  if (!isMoving && !isChoosingDirection) {
    state = "idle";
    frame = (frame + 1) % 16;
    updateSprite();
  }
}
setInterval(idleLoop, 31.25); // ~500ms cho 16 frame idle

character.style.left = `${posX}px`;
character.style.top = `${posY}px`;
updateSprite();
chooseDirection();
</script>
</body>
</html>
