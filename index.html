<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YattaD</title>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f8f8ff;
            overflow: hidden;
            height: 100%;
            width: 100%;
            display: flex;
        }

        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('assets/Dat.png');
            background-size: 98px 98px;
            opacity: 0.3;
            z-index: 0;
        }

        .menu-vertical {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 16px;
            z-index: 3;
        }

        .menu-vertical a {
            text-decoration: none;
            color: #334;
            font-size: 1.3em;
            font-family: 'VT323', monospace;
            transition: transform 0.2s ease, color 0.2s ease;
        }

        .menu-vertical a:hover {
            transform: scale(1.1);
            color: #4e5ba6;
        }

        .container {
            margin: auto;
            text-align: center;
            z-index: 2;
            width: 100vw;
        }

        .hero {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .hero-logo-wrap {
            position: relative;
            height: 110px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            width: 100%;
        }

        .hero-logo {
            display: flex;
            align-items: flex-end;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            transition: transform 1.2s ease-in-out;
            z-index: 2;
            justify-content: flex-start;
        }

        .hero-logo.moved {
            transform: translateX(calc(-50% - 62px)); /* Lướt sang trái */
        }

        .hero-logo-text {
            font-family: 'Pixelify Sans', sans-serif;
            font-size: 3em;
            margin: 0;
            white-space: nowrap;
        }

        .hero-desc {
            font-family: 'VT323', monospace;
            font-size: 1.6em;
            color: #444;
            margin-top: 0.4em;
            margin-bottom: 0;
            z-index: 1;
        }

        #character {
            width: 62px;
            height: 62px;
            image-rendering: pixelated;
            pointer-events: none;
            position: relative;
            left: -10px; /* Điều chỉnh vị trí sang trái */
            top: 0;
            z-index: 3;
            transition: opacity 0.2s;
        }

        #character.absolute {
            position: absolute !important;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        @media (max-width: 600px) {
            .hero-logo-text {
                font-size: 2em;
            }

            .hero-logo-wrap {
                height: 80px;
            }
        }
    </style>
</head>
<body>

    <div class="background"></div>

    <nav class="menu-vertical">
        <a href="about.html">Giới thiệu</a>
        <a href="illustrations.html">Minh Họa</a>
        <a href="concepts.html">Thiết kế</a>
        <a href="comics.html">Truyện Tranh</a>
    </nav>

    <div class="container">
        <header class="hero">
            <div class="hero-logo-wrap">
                <div class="hero-logo centered" id="heroLogo">
                    <img id="character" src="assets/character/Idle/Idle00.png" alt="Vydra" />
                    <h1 class="hero-logo-text" id="logoText">YattaD</h1>
                </div>
            </div>
            <p class="hero-desc" id="heroDesc">Chào mừng đến với trang web cá nhân của YattaD</p>
        </header>
    </div>

    <script>
        let state = "idle";
        let direction = "";
        let isMoving = false;
        let idleFrame = 0;
        let moveFrame = 0;
        const frameSize = 62;
        const directions = ["U", "L", "R"];
        const dirVectors = {
            "U": [0, -1],
            "L": [-1, 0],
            "R": [1, 0]
        };

        let character, heroLogo, logoText, heroDesc;
        let posX = 0, posY = 0;
        let isFirstMove = true;

        function preloadImages(callback) {
            const folders = ["Idle", "Walk", "Run"];
            const allDirs = ["", "U", "L", "R"];
            const counts = { "Idle": 16, "Walk": 16, "Run": 8 };
            let loaded = 0;
            let totalImages = 0;
            let callbackCalled = false;

            folders.forEach(folder => {
                const dirsForFolder = folder === 'Idle' ? allDirs : directions;
                dirsForFolder.forEach(() => {
                    totalImages += counts[folder];
                });
            });

            folders.forEach(folder => {
                const dirsForFolder = folder === 'Idle' ? allDirs : directions;
                dirsForFolder.forEach(dir => {
                    const prefix = folder + dir;
                    for (let i = 0; i < counts[folder]; i++) {
                        const frameStr = folder === "Run" ? `${i}` : i.toString().padStart(2, "0");
                        const img = new Image();
                        img.src = `assets/character/${folder}/${prefix}${frameStr}.png`;
                        img.onload = img.onerror = () => {
                            loaded++;
                            if (loaded >= totalImages && !callbackCalled) {
                                callbackCalled = true;
                                callback();
                            }
                        };
                    }
                });
            });
        }

        function updateSprite() {
            const folder = state.charAt(0).toUpperCase() + state.slice(1);
            const base = folder + direction;
            const idx = state === "run" ? moveFrame % 8 :
                state === "idle" ? idleFrame % 16 :
                moveFrame % 16;
            const frame = state === "run" ? `${idx}` : idx.toString().padStart(2, "0");
            if (character) character.src = `assets/character/${folder}/${base}${frame}.png`;
        }

        function checkCollision(dx, dy) {
            let next = {
                left: posX + dx,
                top: posY + dy,
                right: posX + dx + frameSize,
                bottom: posY + dy + frameSize
            };
            
            const bounds = { width: window.innerWidth, height: window.innerHeight };
            if (next.left < 0 || next.top < 0 || next.right > bounds.width || next.bottom > bounds.height) return true;

            let curHeroLogoRect = heroLogo.getBoundingClientRect();
            let curHeroDescRect = heroDesc.getBoundingClientRect();
            if (rectsOverlap(next, curHeroLogoRect)) return true;
            if (rectsOverlap(next, curHeroDescRect)) return true;

            return false;
        }

        function smoothMove(dx, dy, onFinish, mode) {
            const frames = mode === "run" ? 8 : 16;
            const speed = mode === "run" ? 35 : 70;
            let i = 0, stepX = dx / frames, stepY = dy / frames;
            function step() {
                if (i >= frames) {
                    if (onFinish) onFinish();
                    return;
                }
                posX += stepX;
                posY += stepY;
                character.style.left = `${posX}px`;
                character.style.top = `${posY}px`;
                moveFrame = i;
                updateSprite();
                i++;
                setTimeout(step, speed);
            }
            step();
        }
        
        function autoMoveOutOfLogo(onFinish) {
            const forcedDirection = "L";  // Di chuyển ngược lại
            const [vx, vy] = dirVectors[forcedDirection];
            state = "walk";
            direction = forcedDirection;
            moveFrame = 1;
            updateSprite();
            smoothMove(vx * frameSize, vy * frameSize, onFinish, "walk");
        }

        function moveCharacterOutOfLogo() {
            let charRect = character.getBoundingClientRect();
            posX = charRect.left;
            posY = charRect.top;
            character.classList.add('absolute');
            character.style.left = `${posX}px`;
            character.style.top = `${posY}px`;
            character.style.zIndex = 2;
            document.body.appendChild(character);
        }

        function startIdleAnimation() {
            setInterval(() => {
                if (state === "idle") {
                    idleFrame++;
                    updateSprite();
                }
            }, 200);
        }

        function mainIdleAuto() {
            setTimeout(() => {
                moveCharacterOutOfLogo();

                autoMoveOutOfLogo(() => {
                    // Tính toán lại vị trí logo
                    heroLogo.classList.add('moved');
                    setTimeout(() => {
                        heroLogo.classList.remove('moved'); // Trả về vị trí ban đầu
                    }, 1200); // Thời gian để lướt về
                    scheduleNextAction();
                });

            }, 3000);
        }

        function scheduleNextAction() {
            setTimeout(() => {
                const chance = Math.random();
                const steps = 1 + Math.floor(Math.random() * 3);
                if (chance < 0.2) {
                    state = "idle";
                    direction = "";
                    updateSprite();
                    scheduleNextAction();
                } else if (chance < 0.65) {
                    startMove(steps, "walk");
                } else {
                    startMove(steps, "run");
                }
            }, 1000 + Math.random() * 2500);
        }

        function startMove(steps, mode) {
            if (isMoving) return;
            isMoving = true;
            
            let availableDirs = directions.filter(dir => {
                let [vx, vy] = dirVectors[dir];
                return !checkCollision(vx * frameSize, vy * frameSize);
            });

            if (availableDirs.length === 0) {
                isMoving = false;
                state = "idle";
                direction = "";
                updateSprite();
                scheduleNextAction();
                return;
            }
            direction = availableDirs[Math.floor(Math.random() * availableDirs.length)];
            state = mode;
            moveFrame = 1;
            updateSprite();
            const [vx, vy] = dirVectors[direction];
            let count = 0;

            function next() {
                if (count >= steps || checkCollision(vx * frameSize, vy * frameSize)) {
                    isMoving = false;
                    state = "idle";
                    direction = "";
                    updateSprite();
                    scheduleNextAction();
                    return;
                }
                smoothMove(vx * frameSize, vy * frameSize, next, mode);
                count++;
            }
            next();
        }

        window.onload = () => {
            character = document.getElementById("character");
            heroLogo = document.getElementById("heroLogo");
            logoText = document.getElementById("logoText");
            heroDesc = document.getElementById("heroDesc");
            
            setTimeout(() => {
                heroLogo.style.left = `calc(50% - 31px)`; // Căn chỉnh logo
                heroLogo.style.transform = "translateX(-50%)"; // Đảm bảo logo ở giữa
            }, 10);

            preloadImages(() => {
                direction = "";
                updateSprite();
                startIdleAnimation();
                mainIdleAuto();
            });
        };
    </script>
</body>
</html>
